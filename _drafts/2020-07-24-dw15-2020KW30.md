---
layout: post
title: >-
    Discoveries Weekly No. 15 (July 20-July 26, 2020)
category: DiscoveryWeekly
---

Here are some discoveries that fascinate me this week.

* TOC
{:toc}

## Programming

## Use pkgdown, rhub, and GitHub Action for ribiosUtils

This week, I used `pkgdown`, `rhub`, and GitHub Action via the `usethis` package
to allow web-based documentation, checking, and continuous integration and
delivery (CI/CD) for the [ribiosUtils](https://github.com/bedapub/ribiosUtils)
package that I develop. Here are some notes.

## Convert package documentations to a website with pkgdown

[pkgdown](https://pkgdown.r-lib.org/index.html) builds a website form the
package using Rd files (which can come from, for instance, roxygen
documentations).

It is fairly easy to use. If we run it locally, we need first to configure the
package to use `pkgdown` with `usethis::use_pkgdown()`, and then to generate the
website with `pkddown::build_site()`. The site will be stored in the `docs`
directory of the package.

On my first try, I found `pkgdown` had problems with functions whose examples
attempt to write to the standard output or other connections (for instance
`registerLog` and `writerLog` in `ribiosUtils`). These commands will trap
`pkgdown` in a dead, permanent loop complaining connections are not closed. By
wrapping such examples inside `\dontrun{}`, I got rid of the problem.

There are two ways to make the website available on GitHub. We can set the
GitHub pages' source to &lsquo;master branch /docs folder&rsquo;. If we do this,
we can build website locally, commit any changes to GitHub, and pushing the
changes to the GitHub repository.

Alternatively, We can also set the source of GitHub pages to the `gh-pages`
branch of the repository, and setup a GitHub Action (see also below) to
automatically generate and update the website when we push changes. This is the
variant that I used.

### A step-by-step guide to setup pkgdown and gh-pages

Below is a step-by-step guide on how I did it. The steps are also documented
[here](https://ropenscilabs.github.io/actions_sandbox/websites-using-pkgdown-bookdown-and-blogdown.html#deploy-pkgdown).

First, create an empty `gh-pages` branch in the package directory.

```bash
git checkout --orphan gh-pages
git rm -rf .
git commit --allow-empty -m 'Initial gh-pages commit'
git push origin gh-pages
git checkout master
```

Next, configure the package to use `pkgdown` by running the following command in
R console.

```r
usethis::use_pkgdown()
```

Finally, we add the GitHub Action for `pkg` to automatically add documentation.
There is an existing yaml template example in the `actions` package available
on GitHub [r-lib/actions](https://github.com/r-lib/actions).

```r
usethis::use_github_action(url = "https://raw.githubusercontent.com/r-lib/actions/master/examples/pkgdown.yaml")
```

By using this template (see the yaml file for details), we will make `pkgdown`
generate or update the site anytime there is a push event in the master branch.

As soon as we add, commit, and push the yaml file, we have setup the CI/CD of `pkgdown`.

## Test R package building with r-hub

[The R-hub builder](https://builder.r-hub.io/) is a website which can be used to
build a source R package into binaries on many different platforms including
Mac, Linux, and Windows. Its R client, [`rhub`](https://r-hub.github.io/rhub/),
can used to check R code on platforms other than the one the developer is
working on.

For instance, you can run the following commands to test the package residing in
the current directory, even if you are not working on the systems in which the
package will be tested.

```r
myCheck<- check() ## you can choose on which R-hub platforms it will be checked
## the following commands let you examine the results, retrieve URLs, etc.
myCheck$browse()
myCheck$print()
myCheck$livelog()
mycheck$urls()
## useful shortcuts
check_on_linux()
check_on_windows()
## prior to submission to CRAN
check_for_cran() ## very useful for packages need to be submitted to CRAN
check_with_valgrind() ## checking in valgrind to find memory leaks and pointer errors
## retrieve previous checks
previousChecks <- rhub::list_package_checks("PATH",email="maelle.salmon@yahoo.se",howmany=4)
```

When you use `rhub` for the first time, you need to validate the E-mail address.
From then one, an email of checking results will also be sent to that address.

My impression is that `R-hub` and its cliant `rhub` are useful to check the
package and to make sure that the package can be built also on other systems
(especially if it contains compiled code). I find the only drawback is that it
can be slow, especially when the dependent packages need to be first installed.

## Setup GitHub Actions to test R packages and to render pkgdown automatically

The GitHub repository [r-lib/actions](https://github.com/r-lib/actions) lists
commonly used GitHub Actions for the R language. I used to copy and paste action
definition files from there to my packages.

Recently, thanks to [this
tutorial](https://ropenscilabs.github.io/actions_sandbox/) on GitHub Actions
with R from Brown *et al.* (ropenscilabs), I found that the
[usethis](https://github.com/r-lib/actions) package can be used to automate this
process.

## Conclusions
